\section{Transactions}
\label{sec:transactions}

In Figure \ref{fig:defs:utxo-shelley-1}, we give the transaction types modified
to support Plutus scripts. These types are consistent with the Shelley ledger
as much as possible,
except for the following changes:

\begin{itemize}
  \item $\ForFee$ and $\NForFee$: These types are used to sort public key
  spending inputs in a transaction into those used to pay script validation
  fees and those not used
  for fees. $\IsFee$ represents either.

  \item $\ValTag$ and $\InValTag$: These types are used to indicate if a
  transaction is expected to validate.
  $\TxValTag$ represents either.

  \item $\ScriptPlutus$ and $\ScriptMSig$ are two types of scripts this spec
  covers validation of

  \item $\Data$: is the type of all arguments passed to the validator script.

  \item $\ScriptV,~ \ScriptR,~ \ScriptD$: are the types of the validator,
  redeemer and data scripts.

  \item $\Info$: is the additional information an input in a transaction must
  have when spending a script output. This includes the validator and redeemer,
  as well as the resource consumption for validating spending the script output
  , expressed as $\var{exunits}$.

  \item $\TxInScr$: A transaction input spending a script output.

  \item $\TxInTx$: A transaction input (now distinct from the input $\TxIn$ in
  a UTxO entry). Can be a PK-address spending input
  (in which case $\IsFee$ indicates if this input should be used to pay script execution
  fees), or a script-spending input.

  \item $\TxOut,~\TxOutVK,~\TxOutScr$: An arbitrary output type (script or PK),
  as well as special output types for PK and script outputs. The script output
  includes a data script.
\end{itemize}

The types for PendingTx are added in Figure \ref{fig:defs:utxo-pending}.
These roughly match the types currently in the master plutus branch.

In Figure \ref{fig:defs:utxo-shelley-2}, the following types have changed:

\begin{itemize}
  \item $\TxBody$ was changed to have inputs of type $\TxInTx$, and the
  time to live $\Slot$ was replaced by a liveness interval $\Slot \times \Slot$,
  where the first slot is accessed by $\fun{txlst}$
  \item $\TxValTag$ is now part of the $\Tx$ type. This is a tag that is
  set by the slot leader submitting the block containing this transaction.
  It can later be used to re-apply blocks without performing script validation
  again.
  \item $\TxWitness$ is changed to exclude script witnesses. Only PK ones
  are included.
  \item $\fun{scrsize},~\fun{val},~\fun{txlst}$ accessor functions added
\end{itemize}

In Figure \ref{fig:defs:functions-helper} are the helper functions used for
processing transaction data for validation.

\begin{itemize}
  \item $\fun{hashScript},~ \fun{hashData},~\fun{toData}$ are hashing and encoding
  abstract functions.
  \item The other functions are needed for building $\PendingTx$
\end{itemize}

In Figure \ref{fig:defs:functions-valid}, functions for script validation
are presented.

\begin{itemize}
  \item $\fun{valMSIG}$ performs validation for multi-sig scripts
  (this does not require data or redeemer scripts). The abstract $\ExUnits$
  type can be defined to have a MSIG constructor specifically to
  measure msig-related resources.
  \item $\fun{valPLC}$ performs validation for plutus scripts.
  \begin{note}
    these need to be defined still
  \end{note}
\item $\fun{valScriptUpTo}$ is a script validation function. It takes the
validator, redeemer and data scripts, and PendingTx as parameters. It also
takes a term of type $\ExUnits$ as a parameter and performs validation
\textit{limited by resource use as indicated in} $exunits$.
\item The other functions are used to build PendingTx
\end{itemize}

\begin{note}
  $\fun{valScriptUpTo}$  is the name of the function that replaces
  $\fun{evaluateScript}$ in the existing multi-sig script validation
  scheme in the ledger spec.
\end{note}

\begin{figure*}[htb]
  \emph{Abstract types}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}lr}
      \var{gkey} & \VKeyGen & \text{genesis public keys}\\
      \var{gkh} & \KeyHashGen & \text{genesis key hash}\\
      \var{txid} & \TxId & \text{transaction id}\\
      \var{an} & \ApName & \text{application name}\\
      \var{st} & \SystemTag & \text{system tag}\\
      \var{ih} & \InstallerHash & \text{update data}\\
      \var{exunits} & \ExUnits & \text{units of script execution} \\
      \var{f} & \ForFee & \text{inputs intended for script fees} \\
      \var{nf} & \NForFee & \text{inputs not for script fees} \\
      \var{plc} & \ScriptPlutus & \text{Plutus scripts} \\
      \var{msig} & \ScriptMSig & \text{Multisig scripts} \\
      \var{vt} & \InValTag & \text{transaction valid tag} \\
      \var{ivt} & \ValTag & \text{transaction invalid tag} \\
    \end{array}
  \end{equation*}
  \emph{Script types}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}l@{\qquad=\qquad}lr}
      \var{scr} & \Script & \ScriptPlutus \uniondistinct \ScriptMSig \\
      \var{tvtag} & \TxValTag & \ValTag \uniondistinct \InValTag \\
      \var{dat}
      & \Data
      & \Nothing \uniondistinct \mathbb{N}\uniondistinct\mathbb{H}\uniondistinct(\mathbb{N}\times\seqof{\Data})
        \uniondistinct\seqof{\Data}\uniondistinct\seqof{\Data \times \Data}
      & \text{the $\Data$ type}\\
    \end{array}
  \end{equation*}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}l@{\subset}lr}
      \var{script_v}&\ScriptV & \Script & \text{validator script}\\
      \var{script_d}&\ScriptD & \Data & \text{data script}\\
      \var{script_r}&\ScriptR & \Data & \text{redeemer script}\\
    \end{array}
  \end{equation*}
%
  \emph{Derived types}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}l@{\qquad=\qquad}lr}
      \var{isf} & \ForFee \uniondistinct \NForFee
      & \text {tag for inputs used to pay script fees}
      \\
      (\var{txid}, \var{ix})
      & \type{TxIn}
      & \TxId \times \Ix
      & \text{UTxO entry reference}
      \\
      \var{(\var{script_v}, \var{script_r},\var{exunits})}
      & \Info
      & \ScriptV \times \ScriptR \times \ExUnits
      & \text{validation data}
      \\
      (\var{txid}, \var{ix}, \var{inf})
      & \type{TxInScr}
      & \TxIn \times \Info
      & \text{script input}
      \\
      \var{txin}
      & \TxInTx
      & (\TxIn \times \IsFee) \uniondistinct \TxInScr
      & \text{transaction input}
      \\
      \var{ptx}
      & \PendingTxInS
      & \TxIn \times (\HashScr \times \HashScr) \times \Coin
      & \text{pending Tx script input}
      \\
      (\var{addr}, c)
      & \type{TxOutVK}
      & \Addr \times \Coin
      & \text{vk address output}
      \\
      (\var{addr}, c)
      & \type{TxOutScr}
      & \type{TxOutVK} \times \ScriptD
      & \text{script address output}
      \\
      \var{txout}
      & \TxOut
      & \TxOutVK \uniondistinct \TxOutScr
      & \text{transaction outputs}
      \\
      \var{utxo}
      & \UTxO
      & \TxIn \mapsto \TxOut
      & \text{unspent tx outputs}
      \\
      \var{wdrl}
      & \Wdrl
      & \AddrRWD \mapsto \Coin
      & \text{reward withdrawal}
      \\
      \var{pup}
      & \PPUpdate
      & \KeyHashGen \mapsto \Ppm \mapsto \Seed
      & \text{PP update}
      \\
      \var{av}
      & \ApVer
      & \N
      & \text{application versions}
      \\
      \var{md}
      & \Metadata
      & \SystemTag\mapsto\InstallerHash
      & \text{application metadata}
      \\
      \var{apps}
      & \Applications
      & \ApName \mapsto (\ApVer \times \Metadata)
      & \text{application versions}
      \\
      \var{aup}
      & \AVUpdate
      & \KeyHashGen \mapsto \Applications
      & \text{application update}
      \\
      \var{up}
      & \Update
      & \PPUpdate \times \AVUpdate
      & \text{update proposal}
    \end{array}
  \end{equation*}
  \caption{Definitions used in the UTxO transition system}
  \label{fig:defs:utxo-shelley-1}
\end{figure*}

\begin{figure*}[htb]
  \emph{PendingTx Types}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}l@{\qquad=\qquad}l}
      \var{ptxiv}
      & \PendingTxInV
      & \TxIn \times \Coin
      \\
      \var{ptxis}
      & \PendingTxInS
      & \TxIn \times (\HashScr \times \HashDat) \times \Coin
      \\
      \var{ptxi}
      & \PendingTxIn
      & \PendingTxInV \uniondistinct \PendingTxInS
      \\
      \var{ptx}
      & \PendingTx
      & \powerset{\PendingTxIn} \times  \powerset{\TxOut} \times \Coin \times
      \PendingTxInS \times (\Slot\times\Slot)
      \\
    \end{array}
  \end{equation*}
  \caption{Definitions used to make PendingTx}
  \label{fig:defs:utxo-pending}
\end{figure*}

\begin{figure*}[htb]
  \emph{Transaction Types}
  %
  \begin{equation*}
    \begin{array}{r@{~\in~}l@{\qquad=\qquad}l}
      \var{txbody}
      & \TxBody
      & \powerset{\TxInTx} \times (\Ix \mapsto \TxOut) \times \seqof{\DCert}
        \times \Coin \times (\Slot\times\Slot) \times \Wdrl \times \Update
      \\
      \var{wit} & \TxWitness & (\VKey \mapsto \Sig)
      \\
      \var{tx}
      & \Tx
      & \TxBody \times \TxWitness \times \TxValTag
    \end{array}
  \end{equation*}
  %
  \emph{Accessor Functions}
  \begin{equation*}
    \begin{array}{r@{~\in~}lr}
      \fun{txinputs} & \Tx \to \powerset{\TxInTx} & \text{transaction inputs} \\
      \fun{txouts} & \Tx \to (\Ix \mapsto \TxOut) & \text{transaction outputs} \\
      \fun{txcerts} & \Tx \to \seqof{\DCert} & \text{delegation certificates} \\
      \fun{txfee} & \Tx \to \Coin & \text{transaction fee} \\
      \fun{txsize} & \Tx \to \Coin & \text{transaction size} \\
      \fun{txttl} & \Tx \to \Slot & \text{time to live} \\
      \fun{txlst} & \Tx \to \Slot & \text{start of liveness interval} \\
      \fun{txwdrls} & \Tx \to \Wdrl & \text{withdrawals} \\
      \fun{txbody} & \Tx \to \TxBody & \text{transaction body}\\
      \fun{txwitsVKey} & \Tx \to (\VKey \mapsto \Sig) & \text{VKey witnesses} \\
      \fun{txup} & \Tx \to \Update & \text{protocol parameter update} \\
      \fun{scrsize} & \Script \uniondistinct \Data \to \Coin & \text{data size} \\
      \fun{val} & \TxOut \to \Coin & \text{output value} \\
      \fun{addr} & \TxOut \to \Addr & \text{output address} \\
      \fun{txvaltag} & \Tx \to \TxValTag & \text{transaction validation tag}\\
    \end{array}
  \end{equation*}
  \caption{Definitions used in the UTxO transition system, cont.}
  \label{fig:defs:utxo-shelley-2}
\end{figure*}
%
\begin{figure*}[htb]
  \emph{Abstract Functions}
  %
  \begin{align*}
    \fun{hashScript} \in & \Script\to \HashScr & \text{compute script hash} \\
    \fun{hashData} \in & \Data \to \HashDat
    & \text{compute hash of data} \\
    \fun{toData} \in & \PendingTx\to \Data
    & \text{encode PendingTx as Data} \\
  \end{align*}
  \emph{Helper Functions}
  %
  \begin{align*}
    & \fun{pendingTxIn} \in \TxInTx \to \Coin \to \PendingTxIn \\
    & \fun{pendingTxIn}~\var{txin}~\var{c} = \\
    & \begin{cases}
          (txin,\fun{hashScript}~{script_v},\fun{hashData}~{script_v},c)
           & \text{if}~\var{txin} = ((txid,ix),(\var{script_v}, \var{script_r},\wcard)) \in \TxInScr \\
          ((txid,ix),c) & \text{if}~
           \var{txin} = ((txid,ix),\wcard) \in (\TxIn \times \IsFee)
      \end{cases}\\
    & \text{build pending Tx input} \\~\\
    & \fun{mkIns} \in \Tx \to \UTxO \to \powerset{\PendingTxIn} \\
    & \fun{mkIns}~\var{tx}~\var{utxo} = \\
    & \{ \fun{pendingTxIn}~\var{txin}~\var{\fun{val}~\var{txout}} ~\vert~ \var{txin} \mapsto \var{txout}
    \in \fun{txins}~\var{tx} \restrictdom \var{utxo}\} \\
    & \text{build pending Tx inputs} \\~\\
    & \fun{validationData} \in \UTxO \to \Tx \to \PendingTxInS \to \PendingTx \\
    & \fun{validationData}~\var{utxo}~\var{tx}~\var{ptxis} = \\ &
    ((\fun{mkIns}~\var{tx}~\var{utxo}),\{ \var{txout}~\vert~ \var{ix} \mapsto \var{txout} \in \fun{txouts}~\var{tx}\},
    \fun{txfee}~{tx},\var{ptxis},(\fun{txlst}~{tx},\fun{txttl}~{tx})) \\
    & \text{build PendingTx} \\
  \end{align*}
  \caption{Script Validation}
  \label{fig:defs:functions-helper}
\end{figure*}
%
\begin{figure*}[htb]
  \emph{Script Validation Functions}
  %
  \begin{align*}
    & \fun{valMSIG} \in \ScriptMSig\to \Data \to \ExUnits \to\Bool \\
    & \text{resource-restricted validation of a multi-sig script} \\~\\
    & \fun{valPLC} \in \ScriptPlutus\to (\Data \times \Data \times \Data \times
    \ExUnits) \to \Bool \\
    & \text{resource-restricted validation of a Plutus script} \\~\\
    & \fun{valScriptUpTo} \in \Script\to (\Data \times \Data \times \Data \times \ExUnits)
    \to\Bool \\
    & \fun{valScriptUpTo}~\var{} \\
    &~~= \begin{cases}
              \fun{valPLC} ~\var{script_v} ~\var{ptx}~\var{exunits}
               & \text{if}~\var{script_v} \in \ScriptMSig \\
              \fun{valMSIG} ~\var{script_v} ~ \var{script_d}~\var{script_r}~\var{ptx}~\var{exunits} & \text{if}~
               \var{script_v} \in \ScriptPlutus
          \end{cases}
    \\ & \text{restricted validate script} \\~\\
  \end{align*}
  %
  \emph{Notation}
  %
  \begin{align*}
    \llbracket \var{script_v} \rrbracket_{\var{exunits}} \var{script_d}~\var{script_r}~\var{ptx}
    &=& \fun{valScriptUpTo} ~\var{script_v} ~ \var{script_d}~\var{script_r}~\var{ptx}~
    \var{exunits}
  \end{align*}
  \caption{Script Validation, cont.}
  \label{fig:defs:functions-valid}
\end{figure*}


\clearpage
