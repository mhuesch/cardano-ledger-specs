\section{Delegation}
\label{sec:delegation-shelley}

In the rules regarding delegation state changes, we must make sure that the
rewards get withdrawn from the rewards accounts only if all scripts
validate.

There are now two base cases for the transition rules for $\mathsf{DELEGS}$,
see Figure \ref{fig:rules:delegation-sequence}. The first is for a validating
transaction, where reward withdrawal does occur. The second is for the non-validating
case, where $\var{rewards}$ is unchanged. We use the $\TxValTag$ value to
distinguish the cases.

Note that in the case one wants to achieve something like a data script
in the reward account address, it is possible to use a partially applied
validator (applied to a specific data script) as the staking credential.

\begin{figure}[hbt]
  \begin{equation}
    \label{eq:delegs-base-r}
    \inference[Seq-delg-base-R]
    {
      \fun{txvaltag}~{tx} \in \ValTag \\~\\
      \var{wdrls} \leteq \txwdrls{tx}
      &
      \var{wdrls} \subseteq \var{rewards}
      \\
      \var{rewards'} \leteq \var{rewards} \unionoverrideRight \{(w, 0) \mid w \in \dom \var{wdrls}\}
    }
    {
      \left(
      \begin{array}{c}
        \var{slot} \\
        \var{txIx} \\
        \var{pp} \\
        \var{tx} \\
        \var{reserves}
      \end{array}
    \right)
      \vdash
      \left(
      \begin{array}{c}
        \left(
        \begin{array}{r}
          \var{stdelegs} \\
          \var{rewards} \\
          \var{delegations} \\
          \var{ptrs} \\
          \var{fdms} \\
          \var{dms} \\
          \var{i_{rwd}}
        \end{array}
        \right) \\~\\
        \left(
        \begin{array}{c}
          \var{stpools} \\
          \var{poolParams} \\
          \var{retiring} \\
          \var{cs} \\
        \end{array}
        \right) \\
      \end{array}
      \right)
      \trans{delegs}{\epsilon}
      \left(
      \begin{array}{c}
        \left(
        \begin{array}{c}
          \var{stdelegs} \\
          \varUpdate{\var{rewards'}} \\
          \var{delegations} \\
          \var{ptrs} \\
          \var{fdms} \\
          \var{dms} \\
          \var{i_{rwd}}
        \end{array}
        \right) \\~\\
        \left(
        \begin{array}{c}
          \var{stpools} \\
          \var{poolParams} \\
          \var{retiring} \\
          \var{cs} \\
        \end{array}
        \right) \\
      \end{array}
      \right)
    }
  \end{equation}

  \nextdef

  \begin{equation}
    \label{eq:delegs-base-nr}
    \inference[Seq-delg-base-NR]
    {
      \fun{txvaltag}~{tx} \in \InValTag \\~\\
      \var{wdrls} \leteq \txwdrls{tx}
    }
    {
      \left(
      \begin{array}{c}
        \var{slot} \\
        \var{txIx} \\
        \var{pp} \\
        \var{tx} \\
        \var{reserves}
      \end{array}
    \right)
      \vdash
      \left(
      \begin{array}{c}
        \left(
        \begin{array}{r}
          \var{stdelegs} \\
          \var{rewards} \\
          \var{delegations} \\
          \var{ptrs} \\
          \var{fdms} \\
          \var{dms} \\
          \var{i_{rwd}}
        \end{array}
        \right) \\~\\
        \left(
        \begin{array}{c}
          \var{stpools} \\
          \var{poolParams} \\
          \var{retiring} \\
          \var{cs} \\
        \end{array}
        \right) \\
      \end{array}
      \right)
      \trans{delegs}{\epsilon}
      \left(
      \begin{array}{c}
        \left(
        \begin{array}{c}
          \var{stdelegs} \\
          \var{rewards} \\
          \var{delegations} \\
          \var{ptrs} \\
          \var{fdms} \\
          \var{dms} \\
          \var{i_{rwd}}
        \end{array}
        \right) \\~\\
        \left(
        \begin{array}{c}
          \var{stpools} \\
          \var{poolParams} \\
          \var{retiring} \\
          \var{cs} \\
        \end{array}
        \right) \\
      \end{array}
      \right)
    }

    \nextdef

    \begin{equation}
      \label{eq:delegs-induct-R}
      \inference[Seq-delg-ind-R]
      {
        \var{c}\in\DCertDeleg \Rightarrow \fun{dpool}~{c} \in \dom \var{stpools} \\
        ptr \leteq (\var{slot},~\var{txIx},~\mathsf{len}~\Gamma) \\~\\
          {
            \begin{array}{c}
              \var{slot}\\
              \var{txIx}\\
              \var{pp}\\
              \var{tx}\\
              \var{reserves}
            \end{array}
          }
        \vdash
        \var{dpstate}
        \trans{delegs}{\Gamma}
        \var{dpstate'}
      \\~\\~\\
      {
        \begin{array}{c}
          \var{slot}\\
          \var{ptr}\\
          \var{pp}\\
          \var{reserves}
        \end{array}
      }
      \vdash
        \var{dpstate'}
        \trans{\hyperref[fig:rules:delpl]{delpl}}{c}
        \var{dpstate''}
      }
      {
      {
        \begin{array}{c}
          \var{slot}\\
          \var{txIx}\\
          \var{pp}\\
          \var{tx}\\
          \var{reserves}
        \end{array}
      }
      \vdash
        \var{dpstate}
        \trans{delegs}{\Gamma; c}
        \varUpdate{\var{dpstate''}}
      }
    \end{equation}

    \nextdef

    \begin{equation}
      \label{eq:delegs-induct-NR}
      \inference[Seq-delg-ind-NR]
      {
        \var{c}\in\DCertDeleg \Rightarrow \fun{dpool}~{c} \in \dom \var{stpools} \\
        ptr \leteq (\var{slot},~\var{txIx},~\mathsf{len}~\Gamma) \\~\\
          {
            \begin{array}{c}
              \var{slot}\\
              \var{txIx}\\
              \var{pp}\\
              \var{tx}\\
              \var{reserves}
            \end{array}
          }
        \vdash
        \var{dpstate}
        \trans{delegs}{\Gamma}
        \var{dpstate'}
      \\~\\~\\
      {
        \begin{array}{c}
          \var{slot}\\
          \var{ptr}\\
          \var{pp}\\
          \var{reserves}
        \end{array}
      }
      \vdash
        \var{dpstate'}
        \trans{\hyperref[fig:rules:delpl]{delpl}}{c}
        \var{dpstate''}
      }
      {
      {
        \begin{array}{c}
          \var{slot}\\
          \var{txIx}\\
          \var{pp}\\
          \var{tx}\\
          \var{reserves}
        \end{array}
      }
      \vdash
        \var{dpstate}
        \trans{delegs}{\Gamma; c}
        \varUpdate{\var{dpstate''}}
      }
    \end{equation}
  \caption{Delegation sequence rules}
  \label{fig:rules:delegation-sequence}
\end{figure}


\clearpage
